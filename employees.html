<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>بيانات الموظفين والتنبيهات</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  background: #eef3ff;
  padding: 20px;
  margin: 0;
}
h1 {
  text-align: center;
  color: #1e3c72;
  margin-bottom: 20px;
  font-size: 2.5rem;
}
.controls {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
}
input, select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
}

.counters, .expiring {
  text-align: center;
  font-weight: bold;
  line-height: 1.6;
  margin-bottom: 25px;
  background: #fff;
  display: inline-block;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
}

.cards {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}

.card {
  width: 340px;
  background: #fff;
  border-radius: 15px;
  padding: 18px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  position: relative;
  line-height: 1.4;
  transition: transform .3s, box-shadow .3s;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 22px rgba(0,0,0,0.18);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.card h3 {
  margin: 0;
  font-size: 18px;
  color: #1e3c72;
}
.card-id {
  font-size: 14px;
  color: #555;
}

.alert-label {
  padding: 6px 12px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  font-size: 13px;
  margin-bottom: 6px;
  display: inline-block;
}

.alert-residence { background: #f0ad4e; }   /* أصفر */
.alert-passport { background: #5bc0de; }    /* أزرق فاتح */
.alert-contract { background: #f39c12; }   /* برتقالي */
.alert-inactive { background: #6c757d; }   /* رمادي */

.details-btn {
  width: 100%;
  padding: 10px;
  margin-top: 12px;
  border: none;
  background: linear-gradient(135deg,#1e3c72,#2a65c8);
  color: white;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  font-size: 15px;
  transition: 0.3s;
}
.details-btn:hover {
  background: linear-gradient(135deg,#2a5298,#1e3c72);
}

.extra {
  display: none;
  margin-top: 10px;
  border-top: 1px solid #ddd;
  padding-top: 10px;
  font-size: 14px;
}
.extra p { margin: 4px 0; }

/* تحسين عرض التنبيهات */
#alerts-section {
  max-width: 1000px;
  margin: 30px auto;
  background: #ffeaea;
  border-radius: 15px;
  padding: 20px 25px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
#alerts-section h2 {
  color: #e74c3c;
  text-align: center;
  margin-bottom: 20px;
}
#alerts-section p {
  text-align: center;
  margin: 5px 0;
  font-weight: bold;
  font-size: 1rem;
  line-height: 1.5;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<h1>بيانات الموظفين</h1>

<!-- قسم التنبيهات -->
<div id="alerts-section">
<h2>تنبيهات قرب انتهاء الإقامة والجواز</h2>
<p id="alertsText">جاري تحميل البيانات...</p>
</div>

<div class="controls">
  <input type="text" id="searchInput" placeholder="بحث بالاسم أو رقم الإقامة">
  <select id="nationalityFilter">
    <option value="">كل الجنسيات</option>
  </select>
</div>

<div class="counters" id="counters">
  السعوديون النشطون: 0 | غير السعوديين النشطين: 0
</div>

<div class="cards" id="cards"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWS2KglkUT8Pc3L39dcKFosvR3LWKNQv_EVmYbsLZKx2MBVS33EZQGjk6Yb1mmR9XKKaPK_6qVzbi5/pub?output=csv";
let allData = [];

function parseDate(str) {
  if (!str) return null;
  str = str.toString().trim().replace(/[\u200B-\u200D\uFEFF]/g,'');
  let d = Date.parse(str); if(!isNaN(d)) return new Date(d);
  if(str.includes("/")) { let p=str.split("/").map(x=>parseInt(x)); if(p.length===3) return new Date(p[2],p[1]-1,p[0]); }
  if(str.includes("-")) { let p=str.split("-").map(x=>parseInt(x)); if(p.length===3) return new Date(p[2],p[1]-1,p[0]); }
  return null;
}

function daysUntil(date) { 
  if(!date||isNaN(date)) return null; 
  const t=new Date(); t.setHours(0,0,0,0); date.setHours(0,0,0,0); 
  return Math.ceil((date-t)/(1000*60*60*24)); 
}

function renderCards(data){
  const cardsContainer=document.getElementById("cards");
  cardsContainer.innerHTML="";
  let saudiCount=0, nonSaudiCount=0, expiringResidences=0, expiringPassports=0;
  let expiringResidencesList=[], expiringPassportsList=[];

  data.forEach(rawRow=>{
    const row={}; 
    for(let key in rawRow) row[key.trim()]=rawRow[key]?.trim();

    const isInactive=!!row["تاريخ نهاية الخدمة"];
    const isActive=!isInactive;
    if(isActive){ if(row["الجنسية"]==="سعودي") saudiCount++; else if(row["الجنسية"]) nonSaudiCount++; }

    const alerts=[];
    const resDays=daysUntil(parseDate(row["تاريخ انتهاء الاقامة"]));
    const passDays=daysUntil(parseDate(row["تاريخ انتهاء جواز السفر"]));

    if(isInactive) alerts.push({text:"❌ غير نشط", class:"alert-inactive"});
    else{
      if(resDays!==null && resDays<=30){alerts.push({text:"⚠️ الإقامة قرب الانتهاء", class:"alert-residence"}); expiringResidences++; expiringResidencesList.push(row["الاسم"]); }
      if(passDays!==null && passDays<=30){alerts.push({text:"⚠️ الجواز قرب الانتهاء", class:"alert-passport"}); expiringPassports++; expiringPassportsList.push(row["الاسم"]); }
    }

    let card=document.createElement("div"); card.className="card";
    const alertsDiv=document.createElement("div");
    alerts.forEach(a=>{let d=document.createElement("div"); d.className="alert-label "+a.class; d.innerText=a.text; alertsDiv.appendChild(d);});
    card.appendChild(alertsDiv);

    const headerDiv=document.createElement("div"); headerDiv.className="card-header";
    headerDiv.innerHTML=`<h3>${row["الاسم"]||"-"}</h3><span class="card-id">${row["رقم الهوية"]||"-"}</span>`;
    card.appendChild(headerDiv);

    const extraDiv=document.createElement("div"); extraDiv.className="extra";
    extraDiv.innerHTML=`
      <p><strong>المهنة:</strong> ${row["المهنة"]||"-"}</p>
      <p><strong>الجنسية:</strong> ${row["الجنسية"]||"-"}</p>
      <p><strong>تاريخ الميلاد:</strong> ${row["تاريخ الميلاد"]||"-"}</p>
      <p><strong>رقم الجواز:</strong> ${row["رقم الجواز"]||"-"}</p>
      <p><strong>رقم العقد:</strong> ${row["رقم العقد"]||"-"}</p>
      <p><strong>رقم الموظف:</strong> ${row["رقم الموظف"]||"-"}</p>
      <p><strong>رقم الهاتف:</strong> ${row["رقم الهاتف"]||"-"}</p>
      <p><strong>الايميل:</strong> ${row["الايميل"]||"-"}</p>
      <p><strong>تاريخ التعين:</strong> ${row["تاريخ التعين"]||"-"}</p>
      <p><strong>القسم:</strong> ${row["القسم"]||"-"}</p>
      <p><strong>تاريخ انتهاء الإقامة:</strong> ${row["تاريخ انتهاء الاقامة"]||"-"}</p>
      <p><strong>تاريخ انتهاء الجواز:</strong> ${row["تاريخ انتهاء جواز السفر"]||"-"}</p>
      <p><strong>تاريخ نهاية الخدمة:</strong> ${row["تاريخ نهاية الخدمة"]||"-"}</p>`;
    card.appendChild(extraDiv);

    const btn=document.createElement("button"); btn.className="details-btn"; btn.innerText="عرض التفاصيل";
    btn.onclick=()=>{ 
      extraDiv.style.display=extraDiv.style.display==="block"?"none":"block"; 
      btn.innerText=extraDiv.style.display==="block"?"إخفاء التفاصيل":"عرض التفاصيل"; 
    };
    card.appendChild(btn);

    cardsContainer.appendChild(card);
  });

  document.getElementById("counters").innerText=`ا
