<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>بيانات الموظفين والتنبيهات</title>
<style>
body { font-family: Arial, sans-serif; background: #eef3ff; padding: 20px; }
h1 { text-align: center; color: #1e3c72; margin-bottom: 20px; }

.controls { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
input, select { padding: 6px 10px; border-radius: 5px; border: 1px solid #ccc; }

.counters, .expiring { text-align: center; margin-bottom: 15px; font-weight: bold; line-height:1.4; }

.cards { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }

.card { width: 340px; background: #fff; border-radius: 15px; padding: 15px 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); position: relative; line-height: 1.4; transition: transform .3s, box-shadow .3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 12px 22px rgba(0,0,0,0.18); }

.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.card h3 { margin:0; font-size: 17px; color:#1e3c72; }
.card-id { font-size: 14px; color:#555; }

.alert-label { padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; font-size: 13px; margin-bottom: 4px; display:inline-block; }

.alert-residence { background: #f0ad4e; }   /* أصفر */
.alert-passport { background: #5bc0de; }    /* أزرق فاتح */
.alert-contract { background: #f39c12; }   /* برتقالي */
.alert-inactive { background: #6c757d; }   /* رمادي */

.details-btn { width: 100%; padding: 8px; margin-top: 10px; border: none; background: linear-gradient(135deg,#1e3c72,#2a65c8); color: white; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }

.extra { display: none; margin-top: 8px; border-top: 1px solid #ddd; padding-top: 8px; font-size: 14px; }
.extra p { margin: 3px 0; }
</style>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<h1>بيانات الموظفين</h1>

<div class="expiring" id="expiringCounters">
  الإقامات التي قاربت على الانتهاء خلال شهر: 0<br>
  الجوازات التي قاربت على الانتهاء خلال شهر: 0
</div>

<div class="controls">
  <input type="text" id="searchInput" placeholder="بحث بالاسم أو رقم الإقامة">
  <select id="nationalityFilter">
    <option value="">كل الجنسيات</option>
  </select>
</div>

<div class="counters" id="counters">
  السعوديون النشطون: 0 | غير السعوديين النشطين: 0
</div>

<div class="cards" id="cards"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWS2KglkUT8Pc3L39dcKFosvR3LWKNQv_EVmYbsLZKx2MBVS33EZQGjk6Yb1mmR9XKKaPK_6qVzbi5/pub?output=csv";
let allData = [];

function parseDate(str) {
  if (!str) return null;
  str = str.toString().trim().replace(/[\u200B-\u200D\uFEFF]/g,'');
  let d = Date.parse(str); if(!isNaN(d)) return new Date(d);
  if(str.includes("/")) { let p=str.split("/").map(x=>parseInt(x)); if(p.length===3) return new Date(p[2],p[1]-1,p[0]); }
  if(str.includes("-")) { let p=str.split("-").map(x=>parseInt(x)); if(p.length===3) return new Date(p[2],p[1]-1,p[0]); }
  return null;
}

function daysUntil(date) { 
  if(!date||isNaN(date)) return null; 
  const t=new Date(); t.setHours(0,0,0,0); date.setHours(0,0,0,0); 
  return Math.ceil((date-t)/(1000*60*60*24)); 
}

function renderCards(data){
  const cardsContainer=document.getElementById("cards");
  cardsContainer.innerHTML="";
  let saudiCount=0, nonSaudiCount=0, expiringResidences=0, expiringPassports=0;
  let expiringResidencesList=[], expiringPassportsList=[];

  data.forEach(rawRow=>{
    const row={}; 
    for(let key in rawRow) row[key.trim()]=rawRow[key]?.trim(); // تنظيف البيانات

    const isInactive=!!row["تاريخ نهاية الخدمة"];
    const isActive=!isInactive;
    if(isActive){ if(row["الجنسية"]==="سعودي") saudiCount++; else if(row["الجنسية"]) nonSaudiCount++; }

    const alerts=[];
    const resDays=daysUntil(parseDate(row["تاريخ انتهاء الاقامة"]));
    const passDays=daysUntil(parseDate(row["تاريخ انتهاء جواز السفر"]));
    const contractDays=daysUntil(parseDate(row["تاريخ انتهاء العقد"]));

    if(isInactive) alerts.push({text:"❌ غير نشط", class:"alert-inactive"});
    else{
      if(resDays!==null){ if(resDays<=30){alerts.push({text:"⚠️ الإقامة قرب الانتهاء", class:"alert-residence"}); expiringResidences++; expiringResidencesList.push(row["الاسم"]); } else if(resDays<=60) alerts.push({text:"⚠️ الإقامة ستنتهي قريبًا", class:"alert-residence"});}
      if(passDays!==null){ if(passDays<=30){alerts.push({text:"⚠️ الجواز قرب الانتهاء", class:"alert-passport"}); expiringPassports++; expiringPassportsList.push(row["الاسم"]); } else if(passDays<=60) alerts.push({text:"⚠️ الجواز سينتهي قريبًا", class:"alert-passport"});}
      if(contractDays!==null){ if(contractDays<=30) alerts.push({text:"⚠️ العقد قرب الانتهاء", class:"alert-contract"}); else if(contractDays<=60) alerts.push({text:"⚠️ العقد سينتهي قريبًا", class:"alert-contract"});}
    }

    let card=document.createElement("div"); card.className="card";

    const alertsDiv=document.createElement("div");
    alerts.forEach(a=>{let d=document.createElement("div"); d.className="alert-label "+a.class; d.innerText=a.text; alertsDiv.appendChild(d);});
    card.appendChild(alertsDiv);

    // الجزء الأساسي دائمًا ظاهر
    const headerDiv=document.createElement("div"); headerDiv.className="card-header";
    headerDiv.innerHTML=`<h3>${row["الاسم"]||"-"}</h3><span class="card-id">${row["رقم الهوية"]||"-"}</span>`;
    card.appendChild(headerDiv);

    // البيانات المخفية
    const extraDiv=document.createElement("div"); extraDiv.className="extra";
    extraDiv.innerHTML=`
      <p><strong>المهنة:</strong> ${row["المهنة"]||"-"}</p>
      <p><strong>الجنسية:</strong> ${row["الجنسية"]||"-"}</p>
      <p><strong>تاريخ الميلاد:</strong> ${row["تاريخ الميلاد"]||"-"}</p>
      <p><strong>رقم الجواز:</strong> ${row["رقم الجواز"]||"-"}</p>
      <p><strong>رقم العقد:</strong> ${row["رقم العقد"]||"-"}</p>
      <p><strong>رقم الموظف:</strong> ${row["رقم الموظف"]||"-"}</p>
      <p><strong>رقم الهاتف:</strong> ${row["رقم الهاتف"]||"-"}</p>
      <p><strong>الايميل:</strong> ${row["الايميل"]||"-"}</p>
      <p><strong>تاريخ التعين:</strong> ${row["تاريخ التعين"]||"-"}</p>
      <p><strong>القسم:</strong> ${row["القسم"]||"-"}</p>
      <p><strong>تاريخ انتهاء الإقامة:</strong> ${row["تاريخ انتهاء الاقامة"]||"-"}</p>
      <p><strong>تاريخ انتهاء الجواز:</strong> ${row["تاريخ انتهاء جواز السفر"]||"-"}</p>
      <p><strong>تاريخ انتهاء العقد:</strong> ${row["تاريخ انتهاء العقد"]||"-"}</p>
      <p><strong>تاريخ نهاية الخدمة:</strong> ${row["تاريخ نهاية الخدمة"]||"-"}</p>`;
    card.appendChild(extraDiv);

    const btn=document.createElement("button"); btn.className="details-btn"; btn.innerText="عرض التفاصيل";
    btn.onclick=()=>{ 
      extraDiv.style.display=extraDiv.style.display==="block"?"none":"block"; 
      btn.innerText=extraDiv.style.display==="block"?"إخفاء التفاصيل":"عرض التفاصيل"; 
    };
    card.appendChild(btn);

    cardsContainer.appendChild(card);
  });

  document.getElementById("counters").innerText=`السعوديون النشطون: ${saudiCount} | غير السعوديين النشطين: ${nonSaudiCount}`;
  document.getElementById("expiringCounters").innerHTML=`الإقامات التي قاربت على الانتهاء خلال شهر: ${expiringResidences}<br>${expiringResidencesList.join(", ")}<br><br>الجوازات التي قاربت على الانتهاء خلال شهر: ${expiringPassports}<br>${expiringPassportsList.join(", ")}`;
}

function applyFilters(){
  const searchVal=document.getElementById("searchInput").value.toLowerCase();
  const nationalityVal=document.getElementById("nationalityFilter").value;
  let filtered=allData.filter(rawRow=>{
    const row={}; for(let key in rawRow) row[key.trim()]=rawRow[key]?.trim();
    return (row["الاسم"]?.toLowerCase().includes(searchVal) || (row["رقم الهوية"] && row["رقم الهوية"].includes(searchVal))) &&
           (nationalityVal==="" || row["الجنسية"]===nationalityVal);
  });
  renderCards(filtered);
}

Papa.parse(csvUrl, { 
  download:true, 
  header:true, 
  complete:function(results){
    allData = results.data.map(r=>{
      const cleanRow = {};
      for(let key in r){
        cleanRow[key.trim()] = r[key]?.trim();
      }
      return cleanRow;
    });

    const nationalitySelect = document.getElementById("nationalityFilter");
    let uniqueNationalities = Array.from(new Set(allData.map(r=> (r["الجنسية"]||"").trim()).filter(x=>x)));
    uniqueNationalities.forEach(n=>{let o=document.createElement("option"); o.value=n; o.innerText=n; nationalitySelect.appendChild(o);});

    renderCards(allData);
  }
});

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("nationalityFilter").addEventListener("change", applyFilters);
</script>

</body>
</html>
