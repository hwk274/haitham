<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الموظفين - إدارة الموظفين</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
body{font-family:'Cairo',sans-serif;background:#eef3ff;margin:0;}
header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;text-align:center;padding:80px 20px;}
header h1{font-size:2.5rem;margin-bottom:10px;}
header p{font-size:1.2rem;}
nav{background:#fff;display:flex;justify-content:center;gap:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000;}
nav a{padding:12px 25px;font-weight:600;border-radius:6px;color:#1e3c72;transition:.3s;}
nav a:hover{background:#1e3c72;color:#fff;}
#counters{background:#fff;padding:15px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.1);margin:20px auto;text-align:center;font-weight:700;max-width:900px;}
.cards{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-bottom:30px;}
.card{width:320px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.15);opacity:0;transform:translateY(25px);transition:.5s;}
.card.visible{opacity:1;transform:translateY(0);}
.card h3{color:#1e3c72;margin-bottom:8px;}
.card p{font-size:0.95rem;margin:4px 0;}
.btn{padding:10px 20px;background:#1e3c72;color:#fff;border-radius:10px;border:none;font-weight:700;margin:5px;cursor:pointer;}
footer{background:#1e3c72;color:#fff;text-align:center;padding:20px;}
</style>
</head>
<body>

<header>
<h1>إدارة الموظفين</h1>
<p>متابعة الإقامات والجوازات والعقود مع التنبيهات</p>
</header>

<nav>
<a href="#counters">عداد التنبيهات</a>
<a href="#cards">قائمة الموظفين</a>
<a href="index.html">الصفحة الرئيسية</a>
</nav>

<div id="counters">جاري التحميل...</div>

<div class="cards" id="cards"></div>

<div style="text-align:center;margin-bottom:30px;">
<button class="btn" onclick="exportExcel()">تصدير Excel</button>
<button class="btn" onclick="exportPDF()">تصدير PDF</button>
</div>

<footer>جميع الحقوق محفوظة © 2025</footer>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWS2KglkUT8Pc3L39dcKFosvR3LWKNQv_EVmYbsLZKx2MBVS33EZQGjk6Yb1mmR9XKKaPK_6qVzbi5/pub?output=csv";
let globalData=[];

function parseDate(str){
 if(!str) return null;
 str = str.toString().trim();
 let d=Date.parse(str);
 if(!isNaN(d)) return new Date(d);
 if(str.includes("/")){let p=str.split("/");return new Date(p[2],p[1]-1,p[0]);}
 if(str.includes("-")){let p=str.split("-");return new Date(p[2],p[1]-1,p[0]);}
 return null;
}

function daysUntil(date){
 if(!date) return null;
 const t=new Date(); t.setHours(0,0,0,0);
 date.setHours(0,0,0,0);
 return Math.ceil((date-t)/(1000*60*60*24));
}

function renderEmployees(data){
 const container=document.getElementById("cards");
 container.innerHTML="";

 let active=[], inactive=[];
 let saudiCount=0, nonSaudiCount=0;

 data.forEach(r=>{
   r=Object.fromEntries(Object.entries(r).map(([k,v])=>[k.trim(),v?.trim()]));
   const isActive = r["الحالة"]?.toLowerCase() === "نشط";
   if(isActive){
     active.push(r);
     if(r["الجنسية"]==="سعودي") saudiCount++;
     else if(r["الجنسية"]) nonSaudiCount++;
   } else inactive.push(r);
 });

 const allOrdered=[...active,...inactive];

 allOrdered.forEach(r=>{
   const alerts=[];
   if(r["الحالة"]?.toLowerCase()!=="نشط") alerts.push("❌ غير نشط");
   const resDays = daysUntil(parseDate(r["تاريخ انتهاء الاقامة"]));
   if(r["الحالة"]?.toLowerCase()==="نشط" && resDays!==null && resDays<=30) alerts.push(`⚠️ الإقامة تنتهي بعد ${resDays} يوم`);

   const card=document.createElement("div");
   card.className="card";
   card.innerHTML=`
     <h3>${r["الاسم"]||"-"}</h3>
     <p>${alerts.join(" | ")}</p>
     <p>الجنسية: ${r["الجنسية"]||"-"} | الحالة: ${r["الحالة"]||"-"}</p>
     <p>رقم الهوية: ${r["رقم الهوية"]||"-"} | رقم الجواز: ${r["رقم الجواز"]||"-"}</p>
   `;
   container.appendChild(card);
 });

 const totalActive=saudiCount+nonSaudiCount;
 const saudization = totalActive>0 ? ((saudiCount/totalActive)*100).toFixed(1):0;
 document.getElementById("counters").innerText=
   `السعوديون النشطون: ${saudiCount} | غير السعوديين النشطين: ${nonSaudiCount} | نسبة السعودة: ${saudization}%`;

 document.querySelectorAll(".card").forEach(c=>c.classList.add("visible"));
}

Papa.parse(csvUrl,{
 download:true,
 header:true,
 complete:function(results){
   globalData=results.data;
   renderEmployees(globalData);
 }
});

function exportExcel(){
 const ws=XLSX.utils.json_to_sheet(globalData);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Employees");
 XLSX.writeFile(wb,"employees_report.xlsx");
}

async function exportPDF(){
 const { jsPDF } = window.jspdf;
 const doc=new jsPDF();
 let y=10;
 doc.setFontSize(14);
 doc.text("تقرير الموظفين",10,y); y+=10;

 globalData.forEach(r=>{
   r=Object.fromEntries(Object.entries(r).map(([k,v])=>[k.trim(),v?.trim()]));
   const alerts=[];
   if(r["الحالة"]?.toLowerCase()!=="نشط") alerts.push("غير نشط");
   const resDays = daysUntil(parseDate(r["تاريخ انتهاء الاقامة"]));
   if(r["الحالة"]?.toLowerCase()==="نشط" && resDays!==null && resDays<=30) alerts.push(`الإقامة تنتهي بعد ${resDays} يوم`);

   doc.setFontSize(11);
   doc.text(`الاسم: ${r["الاسم"]||"-"}`,10,y); y+=6;
   doc.text(`الجنسية: ${r["الجنسية"]||"-"} | الحالة: ${r["الحالة"]||"-"}`,10,y); y+=6;
   if(alerts.length>0){ doc.text(`تنبيهات: ${alerts.join(" | ")}`,10,y); y+=6; }
   y+=4;
   if(y>270){doc.addPage();y=10;}
 });

 doc.save("employees_report.pdf");
}
</script>

</body>
</html>
