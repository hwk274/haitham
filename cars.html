<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª </title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:'Cairo',sans-serif;background:#f4f6fb;margin:0;padding:20px;}
h1{text-align:center;color:#1e3c72;margin-bottom:20px;}

.top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
}
.back-btn{
    background:#1e3c72;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:10px;
    cursor:pointer;
    font-size:15px;
}

/* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
.alerts-container{margin-bottom:20px; display:flex; flex-direction:column; gap:5px;}
.alert-top{padding:10px;border-radius:10px;font-weight:bold;color:white;margin-bottom:5px;}
.alert-inspection{background:#f39c12;}  /* Ø§Ù„ÙØ­Øµ */
.alert-form{background:#3498db;}        /* Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© */
.alert-operation{background:#2ecc71;}   /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ */
.alert-insurance{background:#9b59b6;}   /* Ø§Ù„ØªØ£Ù…ÙŠÙ† */
.alert-expired{background:#e74c3c;}     /* Ù…Ù†ØªÙ‡ÙŠ */

.filters{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;}
.filters select,input{padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-size:0.95rem;}

.cards-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
.card{background:white;border-radius:15px;box-shadow:0 6px 20px rgba(0,0,0,.1);padding:20px;position:relative;transition:transform .3s,box-shadow .3s;}
.card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,.2);}
.card h2{margin-bottom:10px;color:#1e3c72;}
.card p{margin:6px 0;font-size:0.95rem;color:#333;}

.details{
    background:#f1f3ff;
    padding:10px;
    border-radius:10px;
    margin-top:10px;
    display:none;
}

.toggle-btn{
    background:#2a5298;
    color:white;
    border:none;
    padding:7px 12px;
    border-radius:8px;
    cursor:pointer;
    margin-top:5px;
}

.card .tag{display:inline-block;padding:4px 10px;border-radius:8px;font-size:0.8rem;color:white;margin-right:5px;}
.expired{background:#e74c3c;}
.near-expiry{background:#f1c40f;color:#856404;}
.valid{background:#2ecc71;}

.card .alert{position:absolute;top:10px;left:10px;padding:4px 8px;border-radius:6px;color:white;font-size:0.8rem;font-weight:bold;}
.card .alert.expired{background:#e74c3c;}
.card .alert.near-expiry{background:#f1c40f;color:#856404;}
</style>
</head>
<body>

<div class="top-bar">
    <div></div>
    <h1>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª - Ù…ØµØ­Ø­</h1>
    <button class="back-btn" onclick="window.location.href='index.html'">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
<div class="alerts-container" id="mainAlerts"></div>

<div class="filters">
  <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡...">
  <select id="filterUsage"><option value="">ÙƒÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª</option></select>
  <select id="filterType"><option value="">ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option></select>
  <select id="filterModel"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</option></select>
</div>

<div class="cards-container" id="cardsContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRB0P_xju8oG-LTgbRxdlcGlBXjCHvLxO9SVAyyvZg6LWqskbZBEFXG5sQa9Zgaik2ZXEmFtXO4xu8f/pub?output=csv';
let carsData = [];

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
function parseDate(dateStr){
  if(!dateStr || dateStr.trim()==="") return null;
  if(dateStr.includes('/')){
    const parts=dateStr.split('/');
    return new Date(parts[2],parts[1]-1,parts[0]);
  }
  return new Date(dateStr);
}

// Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function getStatus(dateStr){
  const d=parseDate(dateStr);
  if(!d) return '';
  const today=new Date();
  const diff=(d-today)/(1000*60*60*24);
  if(diff<0) return 'expired';
  if(diff<=30) return 'near-expiry';
  return 'valid';
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±Øª
function createCard(car){
  const card=document.createElement('div');
  card.classList.add('card');

  // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ù„ÙˆÙŠ
  let alertHTML='';
  ['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ','Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©','Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„','Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ§Ù…ÙŠÙ†'].forEach(field=>{
    const status=getStatus(car[field]);
    if(status==='expired'){
      alertHTML='<div class="alert expired">Ù…Ù†ØªÙ‡ÙŠ</div>';
    } else if(status==='near-expiry' && alertHTML===''){
      alertHTML='<div class="alert near-expiry">Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>';
    }
  });

  card.innerHTML=`
    ${alertHTML}
    <h2>${car['Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} - ${car['Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</h2>

    <button class="toggle-btn" onclick="
      const d=this.nextElementSibling;
      d.style.display = d.style.display==='block' ? 'none' : 'block';
      this.textContent = d.style.display==='block' ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
    ">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>

    <div class="details">
        <p>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${car['Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        <p>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car['Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        <p>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„: ${car['Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        <p>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${car['Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
        <p>Ø§Ù„Ù…ÙÙˆØ¶: ${car['Ø§Ø³Ù… Ø§Ù„Ù…ÙÙˆØ¶'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>

        <p><span class="tag ${getStatus(car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ'])}">ğŸ›  Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ: ${car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
        <p><span class="tag ${getStatus(car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©'])}">ğŸ“„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©: ${car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
        <p><span class="tag ${getStatus(car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„'])}">ğŸ’³ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
        <p><span class="tag ${getStatus(car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ§Ù…ÙŠÙ†'])}">ğŸ›¡ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†: ${car['Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ§Ù…ÙŠÙ†'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></p>
    </div>
  `;
  return card;
}

// Ø¹Ø±Ø¶
function renderCards(data){
  const container=document.getElementById('cardsContainer');
  container.innerHTML='';
  data.forEach(car=>container.appendChild(createCard(car)));
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
function renderMainAlerts(data){
  const container = document.getElementById('mainAlerts');
  container.innerHTML = '';

  const alertFields = [
    {field:'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ', label:'ğŸ›  Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ', class:'alert-inspection'},
    {field:'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©', label:'ğŸ“„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©', class:'alert-form'},
    {field:'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„', label:'ğŸ’³ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„', class:'alert-operation'},
    {field:'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ§Ù…ÙŠÙ†', label:'ğŸ›¡ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†', class:'alert-insurance'}
  ];

  alertFields.forEach(alert=>{
    const nearExpiry = data.filter(car => getStatus(car[alert.field])==='near-expiry');
    const expired = data.filter(car => getStatus(car[alert.field])==='expired');

    if(nearExpiry.length > 0){
      const div = document.createElement('div');
      div.classList.add('alert-top', alert.class);
      div.innerHTML = `<strong>${alert.label} Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (${nearExpiry.length}):</strong> ` +
        nearExpiry.map(c=>`${c['Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} (${c['Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'})`).join(' | ');
      container.appendChild(div);
    }

    if(expired.length > 0){
      const div = document.createElement('div');
      div.classList.add('alert-top','alert-expired');
      div.innerHTML = `<strong>${alert.label} Ù…Ù†ØªÙ‡ÙŠ (${expired.length}):</strong> ` +
        expired.map(c=>`${c['Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} (${c['Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©'] || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'})`).join(' | ');
      container.appendChild(div);
    }
  });
}

// Ø§Ù„ÙÙ„Ø§ØªØ±
function populateFilters(data){
  const usageSet=new Set(), typeSet=new Set(), modelSet=new Set();
  data.forEach(car=>{
    if(car['Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…']) usageSet.add(car['Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…']);
    if(car['Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©']) typeSet.add(car['Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©']);
    if(car['Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„']) modelSet.add(car['Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„']);
  });

  usageSet.forEach(v=>filterUsage.appendChild(new Option(v,v)));
  typeSet.forEach(v=>filterType.appendChild(new Option(v,v)));
  modelSet.forEach(v=>filterModel.appendChild(new Option(v,v)));
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
Papa.parse(csvUrl,{
  download:true, header:true, skipEmptyLines:true,
  complete:function(results){
    carsData=results.data;
    populateFilters(carsData);
    renderCards(carsData);
    renderMainAlerts(carsData); // â† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  }
});

// Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
function filterData(){
  const term=document.getElementById('searchInput').value.toLowerCase();
  const usage=filterUsage.value;
  const type=filterType.value;
  const model=filterModel.value;

  const filtered=carsData.filter(car=>{
    const matchesSearch=Object.values(car).some(v=>v && v.toLowerCase().includes(term));
    const matchesUsage=usage ? car['Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…']===usage : true;
    const matchesType=type ? car['Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©']===type : true;
    const matchesModel=model ? car['Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„']===model : true;
    return matchesSearch && matchesUsage && matchesType && matchesModel;
  });
  renderCards(filtered);
  renderMainAlerts(filtered); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
}

searchInput.addEventListener('input',filterData);
filterUsage.addEventListener('change',filterData);
filterType.addEventListener('change',filterData);
filterModel.addEventListener('change',filterData);
</script>

</body>
</html>
