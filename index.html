<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
body{font-family:'Cairo',sans-serif;background:#f0f2f8;color:#333;padding:25px;}
h2{color:#1e3c72;margin-top:25px;}
.section{margin-bottom:45px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.15);}
.cards{display:flex;flex-wrap:wrap;gap:18px;margin-top:10px;}
.card{background:#fff5f5;padding:15px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.13);width:270px;}
.card h3{margin-bottom:6px;color:#b00020;font-size:1.1rem;}
.card p{margin:3px 0;font-size:0.95rem;}
.alert-count{font-weight:800;font-size:1.2rem;color:#e74c3c;margin-bottom:10px;}
.good{color:#28a745}
</style>
</head>
<body>

<div class="section">
  <h2>ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª</h2>
  <div class="alert-count" id="residencyCount">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div class="cards" id="residencyAlerts"></div>
</div>

<div class="section">
  <h2>ğŸš— ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
  <div class="alert-count" id="carCount">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div class="cards" id="carAlerts"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// Ø±ÙˆØ§Ø¨Ø· CSV
const RESIDENCY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWS2KglkUT8Pc3L39dcKFosvR3LWKNQv_EVmYbsLZKx2MBVS33EZQGjk6Yb1mmR9XKKaPK_6qVzbi5/pub?output=csv";
const CARS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRB0P_xju8oG-LTgbRxdlcGlBXjCHvLxO9SVAyyvZg6LWqskbZBEFXG5sQa9Zgaik2ZXEmFtXO4xu8f/pub?output=csv";

// ----------------------
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®
// ----------------------
function parseDate(str){
  if(!str) return null;
  if(str.includes("/")){
    const p=str.split("/");
    return new Date(p[2], p[1]-1, p[0]);
  }
  const d = Date.parse(str);
  return isNaN(d) ? null : new Date(d);
}
function daysUntil(date){
  if(!date) return null;
  const now = new Date();
  now.setHours(0,0,0,0);
  date.setHours(0,0,0,0);
  return Math.ceil((date - now)/(1000*60*60*24));
}

// ----------------------
// âœ¨ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©
// ----------------------
function showResidencyAlerts(data){
  const box = document.getElementById("residencyAlerts");
  const countBox = document.getElementById("residencyCount");
  box.innerHTML = "";
  let count = 0;

  data.forEach(row=>{
    const date = parseDate(row["ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø§Ù…Ø©"]);
    const days = daysUntil(date);

    if(days !== null && days <= 30){
      count++;
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${row["Ø§Ù„Ø§Ø³Ù…"] || "-"}</h3>
        <p>${days >= 0 ? "ØªÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ " + days + " ÙŠÙˆÙ…" : "âŒ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©"}</p>
      `;
      box.appendChild(card);
    }
  });

  countBox.innerHTML = count ? `Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª: ${count}` : `<span class="good">âœ”ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>`;
}

// ----------------------
// âœ¨ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
// ----------------------
function showCarAlerts(data){
  const box = document.getElementById("carAlerts");
  const countBox = document.getElementById("carCount");
  box.innerHTML = "";
  let count = 0;

  data.forEach(car=>{
    let alerts=[];

    function check(field,title){
      const d=parseDate(car[field]);
      const days = daysUntil(d);
      if(days !== null && days <= 30){
        alerts.push(`${title}: ${days >= 0 ? "Ø¨Ø¹Ø¯ "+days+" ÙŠÙˆÙ…" : "âŒ Ù…Ù†ØªÙ‡ÙŠ"}`);
      }
    }

    check("Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙØ­Øµ","ğŸ”§ Ø§Ù„ÙØ­Øµ");
    check("Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©","ğŸ“„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©");
    check("Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„","ğŸ’³ Ø§Ù„ØªØ´ØºÙŠÙ„");
    check("Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ§Ù…ÙŠÙ†","ğŸ›¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†");

    if(alerts.length){
      count++;
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <h3>${car["Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©"] || "-"} | ${car["Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©"] || "-"}</h3>
        <p>${alerts.join("<br>")}</p>
      `;
      box.appendChild(card);
    }
  });

  countBox.innerHTML = count ? `Ø¹Ø¯Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: ${count}` : `<span class="good">âœ”ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø³ÙŠØ§Ø±Ø§Øª</span>`;
}

// ----------------------
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ----------------------
Papa.parse(RESIDENCY_CSV,{download:true,header:true,complete:(r)=>showResidencyAlerts(r.data)});
Papa.parse(CARS_CSV,{download:true,header:true,complete:(r)=>showCarAlerts(r.data)});
</script>

</body>
</html>
